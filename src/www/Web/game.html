<!doctype html>

<html>
<head>
    <meta charset="utf-8">
    <title>æ¸¸æˆç•Œé¢</title>

    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=0;" />
    <meta name="apple-mobile-web-app-capable" content="YES">
    <!--<meta name="apple-mobile-web-app-status-bar-style" content="black">-->
    <meta name="title" content="æµ‹è¯•" />
    <meta name="description" content="æµ‹è¯•" />
    <!-- æœ€æ–°ç‰ˆæœ¬çš„ Bootstrap æ ¸å¿ƒ CSS æ–‡ä»¶ -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="css/game.css" />
</head>

<body>
<div class="row">
    <div class="col-md-12">
        <button type="button" id="endTurn" class="btn btn-danger command-button" style="display: none">å›åˆç»“æŸ</button>
        <button id="enterRoom" type="button" class="btn btn-default">å¿«é€Ÿè¿›å…¥</button>
        <button type="button" class="btn btn-default" data-toggle="modal" data-target="#createModal">åˆ›å»ºæˆ¿é—´</button>
        <button type="button" class="btn btn-default" data-toggle="modal" data-target="#enterModal">åŠ å…¥æˆ¿é—´</button>
        <button id="roomList" type="button" class="btn btn-default">æˆ¿é—´åˆ—è¡¨</button>
        <button id="exitRoom" type="button" class="btn btn-default">é€€å‡ºæˆ¿é—´</button>
        <button id="exitLogin" type="button" class="btn btn-info">é€€å‡º/ç™»å½•</button>
        <button id="startGame" type="button" class="btn btn-success" style="display: none">å¼€å§‹æ¸¸æˆ</button>
        <button type="button" class="btn btn-default" data-toggle="modal" data-target="#rulesModal">æ¸¸æˆè§„åˆ™</button>
    </div>
</div>

<div class="row">
    <div class="col-md- bg-danger">
        <div class="row" style="padding:0 20px 0 20px">
            <div class="col-md-12 col-xs-6 col-sm-6 bg-info">
                <div id="userFrame" lang=""></div>
            </div>
            <div class="col-md-12 col-xs-6 col-sm-6 bg-danger"><h4>æ¶ˆæ¯ï¼ˆå›åˆï¼š<span id="turn"></span>ï¼‰</h4><div id="battleFrame" style="height:150px; overflow:auto"></div></div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="row">
            <div class="col-md-12 bg-warning"><h4>å¡ç‰ŒåŒº <span id="cardPic"></span> </h4></div>
            <div class="col-md-12 bg-warning"><div id="cardFrame" style="height:300px;overflow:auto;"></div></div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="row ">
            <div class="col-md-12 bg-warning"><h4>æˆ¿é—´åˆ—è¡¨</h4></div>
            <div class="col-md-12 bg-warning"><div id="listFrame"></div></div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">åˆ›å»ºæˆ¿é—´</h4>
            </div>
            <div class="modal-body">
               æˆ¿é—´åï¼š<input type="text" id="roomName" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">å…³é—­</button>
                <button type="button" id="createRoomButton" class="btn btn-primary" data-dismiss="modal">åˆ›å»º</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="enterModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel2">åŠ å…¥æˆ¿é—´</h4>
            </div>
            <div class="modal-body">
                æˆ¿é—´åï¼š<input type="text" id="roomName2" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">å…³é—­</button>
                <button type="button" id="enterRoomButton" class="btn btn-primary" data-dismiss="modal">åŠ å…¥</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="rulesModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" >æ¸¸æˆè§„åˆ™</h4>
            </div>
            <div class="modal-body">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<script src="./js/jquery.min.js" ></script>
<!-- æœ€æ–°çš„ Bootstrap æ ¸å¿ƒ JavaScript æ–‡ä»¶ -->
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://cdn.bootcss.com/mustache.js/2.3.0/mustache.min.js"></script>
<!--<script src="./js/config.js"></script>-->
<script>
    let wsServer = window.location.host+':9997'
    let ws = new WebSocket("ws://"+wsServer);


    ws.onopen = function(evt) {
        console.log("Connection open ...");

    };

    ws.onmessage = function(evt) {
        console.log(evt);
        let evtData = JSON.parse(evt.data);
        let list_output;
        //é€»è¾‘å¤„ç†ã€‚ã€‚
        //1001 è¿›å…¥æˆ¿é—´
        console.log('evtData',evtData);
        switch (evtData.type){
            case '1001':
                fMsg(evtData.msg);
                //å·²è¿›å…¥æˆ¿é—´
                $("#startGame").show();
                break;
            case '1004':
                //1004 é€€å‡ºæˆ¿é—´
                fMsg(evtData.msg);
                $("#startGame").hide();
                break;
            case '1002':
                evtData.msg = '<div style="color:#e47c6c">'+evtData.msg+'</div>';
                fMsg(evtData.msg);
                clearBoard();
                $("#startGame").show();
                break;
            case '1003':
                //æˆ¿é—´åˆ—è¡¨
                list_output = Mustache.render($("#roomListTable").html(),evtData.params);
                $('#listFrame').html(list_output);
                break;
            case '2001':
                //æ¸¸æˆç”¨æˆ·ä¿¡æ¯
                list_output = Mustache.render($("#userInfoTable").html(),evtData.params);
                $('#userFrame').html(list_output);
                $(".show_"+$("#userFrame").attr('lang')).css('color','red')
                break;
            case '2002':
                //å¡ç‰Œä¿¡æ¯
                list_output = Mustache.render($("#cardInfoTable").html(),evtData.params);
                let card_pic_output = Mustache.render($("#cardPicList").html(),evtData.params)
                $('#cardFrame').html(list_output);
                $('#cardPic').html(card_pic_output);
                break;
            case '2010':
                //å¯¹æˆ˜åŒºä¿¡æ¯
                fBattleMsg(evtData.msg);
                break;
            case '2011':
                //å›åˆä¿¡æ¯ï¼ˆåŒ…æ‹¬è°çš„å›åˆ)
                $("#turn").html(evtData.params.turn);
                //è°çš„å›åˆ
                if(evtData.params.is_turn_player){
                    $('.command-button').show();
                    $("#is_turn_player").html('->')
                }else{
                    $('.command-button').hide();
                    $("#is_turn_player").html('')
                }
                fBattleMsg(evtData.msg);
                break;
            case '3001':
                //æ¸¸æˆç»“æŸ
                fBattleMsg(evtData.msg);
                $('.command-button').hide();
                break;
            case '9001':
                fMsg(evtData.msg);
                $("#userFrame").attr('lang',evtData.params.uid);
                break;
            default:
                fMsg(evtData.msg);
        }

    };

    ws.onclose = function(evt) {
        console.log("Connection closed.");
    };

    function fMsg(msg) {
        let div = $("#battleFrame");
        div.prepend(msg+'<br />');
    }

    function fBattleMsg(msg) {
        let div = $("#battleFrame");
        div.prepend(msg+'<br />');
    }

    //æ¸…ç©ºç•Œé¢
    function clearBoard(){
        $('.command-button').hide();
        $('#cardFrame').html('');
    }

    $("#enterRoom").click(function () {
       ws.send(JSON.stringify({'type':'enterRoom'}));
    });

    $("#createRoomButton").click(function () {
        console.log('attr',$("#roomName").val());
        ws.send(JSON.stringify({'type':'createRoom','params':[$("#roomName").val()]}));
    });

    $("#enterRoomButton").click(function () {
        console.log('attr',$("#roomName2").val());
        ws.send(JSON.stringify({'type':'enterRoom','params':[$("#roomName2").val()]}));
    });

    $("#roomList").click(function () {
        ws.send(JSON.stringify({'type':'roomList'}));
    });

    $("#exitRoom").click(function () {
        ws.send(JSON.stringify({'type':'exitRoom'}))
        clearBoard()
    });
    $("#exitLogin").click(function () {
        ws.send(JSON.stringify({'type':'exitRoom'}))
        ws.send(JSON.stringify({'type':'destroy'}))
        ws.close()
        $.post('http://'+window.location.host+'/UserController/logout',
            {}
            ,function () {
                window.location.href = '/index.html'
            })

    });

    $("#startGame").click(function () {
        ws.send(JSON.stringify({'type':'startGame'}));
    });
    $("#endTurn").click(function () {
        ws.send(JSON.stringify({'type':'endTurn'}));
    });
    //ä¸ºå¡ç‰Œç»‘å®šäº‹ä»¶
    $("#cardFrame").on("click",".cardSelector a",function () {

        console.log('operation',$(this).attr("operation"));
        let operation = parseInt($(this).attr("operation"));
        let action;
        if(operation >10){
            action = 'drawCard'
        }else{
            action = 'coverCard'
        }
        let card_data = {
           'type':action,
           'params':[
                $(this).attr("order"),operation//card_order,operation
           ]
        }
        console.log(card_data)
        ws.send(JSON.stringify(card_data))
    });

    //è¯·æ±‚è§„åˆ™
    $.get('http://'+window.location.host+'/UserController/rules',
        {}
        ,function (res) {
            if(res.data) {
                $('#rulesModal .modal-body').html(res.data)
            }
        })

</script>
<script id="roomListTable" type="text/html">
    <table class="table table-bordered">
        <tr><th>æˆ¿é—´å</th><th>äººæ•°</th></tr>
        {{#room_list}}<tr><td>{{name}}</td><td>{{num}}</td></tr>{{/room_list}}
    </table>
</script>
<script id="userInfoTable" type="text/html">
    {{#game_info}}
    <div class="show_{{uid}}">
        <div><span id="is_turn_player"></span><span class="show_{{uid}}">{{uid}}</span></div>
            hp:<progress value="{{info.hp}}" max="150"></progress> {{info.hp}}/150
            <div>ğŸ”¥{{info.resource.1}} ğŸ’§{{info.resource.2}} â˜ï¸{{info.resource.3}} âŒšï¸{{info.card_num}}</div>
            <div>ğŸ‘¼ {{#info.buff}}{{name}}{{value}}({{turns}}){{/info.buff}}</div>
    </div>
    {{/game_info}}
    <!--<table class="table table-bordered">-->
        <!--<tr><th>ç”¨æˆ·</th><th>ç”Ÿå‘½</th><th>å¡ç‰Œæ•°</th><th>èµ„æºï¼ˆç«/æ°´/é£ï¼‰</th><th>å…‰ç¯</th></tr>-->

        <!--<tr class="show_{{uid}}">-->
            <!--<td>{{uid}}</td><td>{{info.hp}}</td><td>{{info.card_num}}</td>-->
            <!--<td>{{info.resource.1}}/{{info.resource.2}}/{{info.resource.3}}</td>-->
            <!--<td>{{#info.buff}}{{name}}{{value}}({{turns}}) {{/info.buff}}</td>-->
        <!--</tr>-->

    <!--</table>-->
</script>
<script id="cardPicList" type="text/html">
    {{#card_info}}<img src="{{card_desc.pic}}" style="width:30px;height:30px;margin-right: 10px" />{{/card_info}}
</script>
<script id="cardInfoTable" type="text/html">
    <table id="cardList" class="table table-bordered table-hover">
        {{#card_info}}<tr class="cardSelector" lang="{{card_order}}"><td><img src="{{card_desc.pic}}" style="width:50px;height:50px" /></td>
        <td>{{card_desc.name}}<br />{{card_desc.desc}}</td><td>
            <!--æ“ä½œæŒ‰é’®-->
            <div class="btn-group command-button">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    æ“ä½œ <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" style="left:-100px;">
                    {{#card_desc.is_object}}
                    <li><a href="#" order="{{card_order}}" operation="12">æ‰“å‡º->å¯¹æ‰‹</a></li>
                    <li><a href="#" order="{{card_order}}" operation="13">æ‰“å‡º->è‡ªå·±</a></li>
                    {{/card_desc.is_object}}
                    {{^card_desc.is_object}}
                    <li><a href="#" order="{{card_order}}" operation="11">æ‰“å‡º</a></li>
                    {{/card_desc.is_object}}
                    <li role="separator" class="divider"></li>
                    <li><a href="#" order="{{card_order}}" operation="1">è¦†ç›–ï¼ˆç«ï¼‰</a></li>
                    <li><a href="#" order="{{card_order}}" operation="2">è¦†ç›–ï¼ˆæ°´ï¼‰</a></li>
                    <li><a href="#" order="{{card_order}}" operation="3">è¦†ç›–ï¼ˆé£ï¼‰</a></li>
                </ul>
            </div>
        </td></tr>{{/card_info}}
    </table>
</script>
</body>
</html>